#!/bin/bash
 
#  _                _
# | |__   __ _  ___| | ___   _ _ __
# | '_ \ / _` |/ __| |/ / | | | '_ \
# | |_) | (_| | (__|   <| |_| | |_) |
# |_.__/ \__,_|\___|_|\_\\__,_| .__/
#                             |_|    
#
# Script        : backup
# Location      : /usr/local/bin
# Author        : Jens Ochmann
# Description   : Perform local and external backup.
# Requires root : No

# Load config file
CONFIG_FILE="$HOME/.config/sc.conf"
if [[ -f "$CONFIG_FILE" ]]; then
    source "$CONFIG_FILE"
else
    echo -e "${RED}Error: Configuration file not found.${NC}"
    echo -e "${RED}Please ensure the configuration file 'sc.conf' exists at $HOME/.config/${NC}"
    exit 1
fi

printf "${YELLOW}Starting backup...${NC}\n"

# Check if the external backup drive is available
if [ ! -d "$BACKUP_DIR_EXT" ]; then
    printf "${RED}Error: External backup drive is not available.${NC}\n"
    exit 1
fi

# Create the local backup directory if it does not exist
mkdir -p "$BACKUP_DIR"

# Create the backup archive
tar -czf "$BACKUP_DIR/$BACKUP_FILE" --exclude="$BACKUP_DIR" "$HOME" || printf "${RED}Error creating backup archive.${NC}\n"

# Copy files from local backup to external hard drive using rsync
rsync -avh --progress $BACKUP_DIR/ $BACKUP_DIR_EXT/ || printf "${RED}Error: rsync failed to copy files.${NC}\n"
printf "${YELLOW}Backup copied to external drive.${NC}\n"

# Copy files from local to GitHub folder using gitupd
printf "${YELLOW}Copying files for GitHub...${NC}\n"
gitupd || printf "${RED}Error updating GitHub.${NC}\n"

printf "${YELLOW}Finished all operations.${NC}\n"
